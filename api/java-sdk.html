<!DOCTYPE html>
<html lang="en">
<head prefix="og: http://ogp.me/ns#"><meta name="generator" content="Hexo 3.8.0">
  <meta charset="utf-8">
  <title>Keycard Java SDK 2.0 | Keycard</title>
  <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Canonical links -->
  <link rel="canonical" href="https://status-im.github.io/keycard.status.im/api/java-sdk.html">
  <!-- Alternative links -->
  
    
      <link rel="alternative" hreflang="en" href="https://status-im.github.io/keycard.status.im/api/java-sdk.html">
    
  
  <!-- Icon -->
  <meta name="msapplication-TileColor" content="#ff9c00">
  <meta name="msapplication-TileImage" content="/keycard.status.im/icon/mstile-144x144.png">

  <link rel="icon" type="image/png" href="/keycard.status.im/img/logo-16.png" sizes="16x16">
  <link rel="icon" type="image/png" href="/keycard.status.im/img/logo-32.png" sizes="32x32">

  <link rel="apple-touch-icon" sizes="76x76" href="/keycard.status.im/img/apple-touch-icon-76.png?v=0.0.5">
  <link rel="apple-touch-icon" sizes="120x120" href="/keycard.status.im/img/apple-touch-icon-120.png?v=0.0.5">
  <link rel="apple-touch-icon" sizes="152x152" href="/keycard.status.im/img/apple-touch-icon-152.png?v=0.0.5">
  <link rel="apple-touch-icon" sizes="180x180" href="/keycard.status.im/img/apple-touch-icon-180.png?v=0.0.5">
  <link rel="apple-touch-icon" href="/keycard.status.im/img/apple-touch-icon-1024.png?v=0.0.5">
  <link rel="stylesheet" href="/keycard.status.im/css/main.min.css">
  <link rel="alternate" href="/keycard.status.im/atom.xml" title="Keycard">
  <meta property="og:title" content="Status Incubate: helping #buidl web3">
</head>

<body>
  <div id="container">
    
      <div class="header">
    <div class="header-left">
        <a class="logo" href="/keycard.status.im/"></a>
        
<ul class="main-nav">
    <li class="item--to-show"><a href="https://status.im/get" class="">App</a></li>
    <li class="item--to-show"> <a href="https://our.status.im/">Blog</a> </li>
    <li class="item--to-show"> <a href="https://status.im/docs">Docs</a></li>
    <li class="item--dropdown item--dropdown-projects"> <a href="#" class="">Projects</a></li>
    <li><a href="https://status.im/contribute">Contribute</a></li>
    <li class="item--dropdown"><a href="#" class="item--dropdown-community">Community</a></li>
    <li class="item--more"><a href="#" class="item--more">More</a></li>
</ul>

    </div>
    <div class="header-right">
        <a href="http://get.status.im/chat/public/status-keycard" class="button button--secondary" style="margin-right: 8px">Join Status Chat</a>
    </div>
</div>

<div class="mobile-nav-wrap">
    <div class="mobile-nav-inner">
        <a class="logo" href="/keycard.status.im/"></a>
        <a class="icon-close mobile-nav-close" href="#"></a>
        <ul class="mobile-nav">
            <li><a href="https://our.status.im/tag/incubate/">Blog</a></li>
            <li><a href="https://status.im/docs">Docs</a></li>
            <li class="item--dropdown item--to-show">
              <span>Projects</span>
              <ul class="mobile-sub-nav">
                <li><a href="https://incubate.status.im/" class="">Incubate</a></li>
                <li><a href="https://nimbus.status.im/" class="">Nimbus</a></li>
                <li><a href="https://embark.status.im/" class="">Embark</a></li>
                <li><a href="https://hardwallet.status.im/" class="">Keycard</a></li>
              </ul>
            </li>
            <li><a href="https://status.im/contribute/" class="">Contribute</a></li>
        </ul>
        <div class="mobile-nav-footer">
            <a href="http://get.status.im/chat/public/status-incubate" class="button button--secondary">Join Status Chat</a>
        </div>
        <header class="dropdown">
            <nav>
                
<ul class="main-nav">
    <li class="item--to-show"><a href="https://status.im/get" class="">App</a></li>
    <li class="item--to-show"> <a href="https://our.status.im/">Blog</a> </li>
    <li class="item--to-show"> <a href="https://status.im/docs">Docs</a></li>
    <li class="item--dropdown item--dropdown-projects"> <a href="#" class="">Projects</a></li>
    <li><a href="https://status.im/contribute">Contribute</a></li>
    <li class="item--dropdown"><a href="#" class="item--dropdown-community">Community</a></li>
    <li class="item--more"><a href="#" class="item--more">More</a></li>
</ul>

            </nav>
        </header>
    </div>
    <div class="popup-overlay"></div>
</div>

<div class="popup-wrap popup-wrap--community">
    <div class="popup popup--community">
        <a class="popup__button popup__button--close"></a>
        <h3 class="popup__title">Community</h3>
        <div class="popup__inner">
            <div class="cards cards--three cards--three--even cards--community cards--community--light">
                <div class="card">
                    <a href="https://get.status.im/chat/public/status" class="card-inner">
                        <div class="community-icon community-icon--join"></div>
                        <h4>Join the chat in Status</h4>
                        <p class="secondary-text">Whisper sweet, encrypted nothings on a distributed network that no-one owns.</p>
                    </a>
                </div>
                <div class="card">
                    <a href="https://discuss.status.im/" class="card-inner">
                        <div class="community-icon community-icon--discussion"></div>
                        <h4>Join the Discussion</h4>
                        <p class="secondary-text">Join longer discussions, work in progress, and our research here.</p>
                    </a>
                </div>
                <div class="card">
                    <a href="https://github.com/status-im/" class="card-inner">
                        <div class="community-icon community-icon--contrubute"></div>
                        <h4>Contribute to our Repos</h4>
                        <p class="secondary-text">Help us #buidl the future by getting involved in the most active code base in Ethereum.</p>
                    </a>
                </div>
            </div>
            <h5>Find Out More</h5>
            <div class="cards cards-community-more cards--three cards--three--even">
                <div class="card">
                    <div class="card-inner">
                        <div class="card-content">
                            <div class="latest-posts latest-news"></div>
                        </div>
                        <div class="card-community-more__link"><a href="https://our.status.im/" class="link-arrow">Learn more</a></div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-inner">
                        <div class="card-content">
                            <h4>Life at Status</h4>
                            <p class="secondary-text">What's it like to live the decentralized lifestyle? Find out here.</p>
                        </div>
                        <div class="card-community-more__link"><a href="https://status.im/contribute/" class="link-arrow">Learn more</a></div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-inner">
                        <div class="card-content">
                            <h4>Follow us on Twitter</h4>
                            <p class="secondary-text">Join the conversation on our social channels to learn more.</p>
                        </div>
                        <div class="card-community-more__link"><a href="https://twitter.com/ethstatus/" class="link-arrow">Learn more</a></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="popup-overlay"></div>
</div>

<div class="popup-wrap popup-wrap--projects">
    <div class="popup popup--projects">
        <a class="popup__button popup__button--close"></a>
        <h3 class="popup__title">Projects</h3>
        <div class="popup__inner">
            <h5>Help us #buidl</h5>
            <div class="cards cards-community-more cards--three cards--three--even">
                <div class="card">
                    <div class="card-inner">
                        <div class="card-content">
                            <h4>Embark</h4>
                            <p class="secondary-text">Embark is a simple and easy to use development framework that enables you to build and deploy your own decentralized applications smoothly.</p>
                        </div>
                        <div class="card-community-more__link"><a href="https://embark.status.im/" class="link-arrow">Learn more</a></div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-inner">
                        <div class="card-content">
                            <h4>Nimbus</h4>
                            <p class="secondary-text">A research project and light client for Ethereum 2.0 designed to perform well on embedded systems and resource-restricted hardware.</p>
                        </div>
                        <div class="card-community-more__link"><a href="https://nimbus.status.im" class="link-arrow">Learn more</a></div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-inner">
                        <div class="card-content">
                            <h4>Keycard</h4>
                            <p class="secondary-text">A hardware wallet in the form of a card with a safe, contactless transaction experience</p>
                        </div>
                        <div class="card-community-more__link"><a href="https://keycard.status.im/" class="link-arrow">Learn more</a></div>
                    </div>
                </div>
            </div>
            <div class="separator"></div>
            <h5>Enable Everyone</h5>
            <div class="cards cards-community-more cards--three cards--three--even">
                <div class="card">
                    <div class="card-inner">
                        <div class="card-content">
                            <h4>Incubate</h4>
                            <p class="secondary-text">Incubate supports open source, early stage startups with funding, technical mentorship, legal and regulatory compliance and much more.</p>
                        </div>
                        <div class="card-community-more__link"><a href="https://incubate.status.im/" class="link-arrow">Learn more</a></div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-inner">
                        <div class="card-content">
                            <h4>Statusphere</h4>
                            <p class="secondary-text">Get involved in our community today, no matter who you are.</p>
                        </div>
                        <div class="card-community-more__link"><a href="https://status.im/statusphere/" class="link-arrow">Learn more</a></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="popup-overlay"></div>
</div>

    
    <div class="site-specific-menu">
    <p>
        <a class="site-name" href="/keycard.status.im/">Keycard</a>
        <a class="specific-nav-link" href="/keycard.status.im/api"><span>API</span></a>
    </p>
</div>
<div class="page-intro wrapper">
  <header class="article-header">
    <h1 class="article-title" itemprop="name">Keycard Java SDK 2.0</h1>
    <a href="https://github.com/status-im/incubate.status.im/edit/develop/source/api/java-sdk.md" class="article-edit-link" title="Improve this doc">Edit on Github</a>
  </header>
</div>
<div id="content-wrap">
  <div id="content" class="wrapper">
    <div id="content-inner">
    <aside id="sidebar" role="navigation">
  <div class="inner">
    <strong class="sidebar-title">Keycard API</strong><a href="index.html" class="sidebar-link">Getting Started</a><a href="java-sdk.html" class="sidebar-link current">Java SDK</a><a href="apdu.html" class="sidebar-link">APDU Protocol</a>
  </div>
</aside>
      <article class="article-container" itemscope="" itemtype="http://schema.org/Article">
        <div class="article-inner">
          <div class="article">
            <div class="inner">
              <div class="article-content" itemprop="articleBody">
                <h2 id="Installation" class="article-heading"><a href="#Installation" class="headerlink" title="Installation"></a>Installation<a class="article-anchor" href="#Installation" aria-hidden="true"></a></h2><p>You can import the SDK in your Gradle or Maven project using <a href="https://jitpack.io" target="_blank" rel="noopener">Jitpack.io</a>. If using Gradle, to use<br>JitPack all you have to do is insert these lines in you <code>build.gradle</code> file</p>
<figure class="highlight groovy"><table><tr><td class="code"><pre><span class="line">allprojects &#123;</span><br><span class="line">  repositories &#123;</span><br><span class="line">    maven &#123; url <span class="string">'https://jitpack.io'</span> &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Then, you must import the correct dependency. In case you are building an Android-based project, you need to add this line</p>
<figure class="highlight groovy"><table><tr><td class="code"><pre><span class="line">dependencies &#123;</span><br><span class="line">  implementation <span class="string">'com.github.status-im.status-keycard-java:android:2.0.0'</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>If you are working on the desktop, then you need this line instead</p>
<figure class="highlight groovy"><table><tr><td class="code"><pre><span class="line">dependencies &#123;</span><br><span class="line">  implementation <span class="string">'com.github.status-im.status-keycard-java:desktop:2.0.0'</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>In both case, you will have the same SDK, except for the way connection with the card is established.</p>
<h2 id="Connecting-to-the-card-Android" class="article-heading"><a href="#Connecting-to-the-card-Android" class="headerlink" title="Connecting to the card (Android)"></a>Connecting to the card (Android)<a class="article-anchor" href="#Connecting-to-the-card-Android" aria-hidden="true"></a></h2><p>On Android, the NFC connection handling must happen on a thread separate from the UI thread. The SDK provides the class <code>NFCCardManager</code> to handle this. This an example activity starting the NFC reader and handling the connection to the card. Refer to the comments in the example for more information.</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span> <span class="keyword">extends</span> <span class="title">AppCompatActivity</span> </span>&#123;</span><br><span class="line">  <span class="keyword">private</span> NfcAdapter nfcAdapter;</span><br><span class="line">  <span class="keyword">private</span> NFCCardManager cardManager;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line">    setContentView(R.layout.activity_main);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Get the Android NFC default adapter</span></span><br><span class="line">    nfcAdapter = NfcAdapter.getDefaultAdapter(<span class="keyword">this</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Create the NFCCardManager, this class is provided by the Keycard SDK and handles connections to the card</span></span><br><span class="line">    cardManager = <span class="keyword">new</span> NFCCardManager();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// The Card Listener receives the connected/disconnected events. These can happen at any time since the user can</span></span><br><span class="line">    <span class="comment">// introduce or remove the card to/from the field at any time. This is where your code goes.</span></span><br><span class="line">    cardManager.setCardListener(<span class="keyword">new</span> CardListener() &#123;</span><br><span class="line">      <span class="meta">@Override</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onConnected</span><span class="params">(CardChannel cardChannel)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// Card is connected. Here you can start working with the Keycard. The CardChannel is what you will use to</span></span><br><span class="line">        <span class="comment">// communicate with the card.</span></span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="meta">@Override</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onDisconnected</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// Card is disconnected (was removed from the field). You can perform cleanup here.</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    cardManager.start();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onResume</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>.onResume();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// We need to enable the reader on resume.</span></span><br><span class="line">    <span class="keyword">if</span> (nfcAdapter != <span class="keyword">null</span>) &#123;</span><br><span class="line">      nfcAdapter.enableReaderMode(<span class="keyword">this</span>, <span class="keyword">this</span>.cardManager, NfcAdapter.FLAG_READER_NFC_A | NfcAdapter.FLAG_READER_SKIP_NDEF_CHECK, <span class="keyword">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onPause</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>.onPause();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// We disable the reader on pause to allow other apps to use it.</span></span><br><span class="line">    <span class="keyword">if</span> (nfcAdapter != <span class="keyword">null</span>) &#123;</span><br><span class="line">      nfcAdapter.disableReaderMode(<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Connecting-to-the-card-Desktop" class="article-heading"><a href="#Connecting-to-the-card-Desktop" class="headerlink" title="Connecting to the card (Desktop)"></a>Connecting to the card (Desktop)<a class="article-anchor" href="#Connecting-to-the-card-Desktop" aria-hidden="true"></a></h2><p>On the desktop we use the javax.smartcardio library. There are several ways to handle connections, the important part is getting a CardChannel open. Below is an example of how this can be achieved (assumes that a single smartcard reader is connected).</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// We create a TerminalFactory object</span></span><br><span class="line">TerminalFactory tf = TerminalFactory.getDefault();</span><br><span class="line">CardTerminal cardTerminal;</span><br><span class="line"></span><br><span class="line"><span class="comment">// We search a terminal with a card inside</span></span><br><span class="line"><span class="keyword">for</span> (CardTerminal t : tf.terminals().list()) &#123;</span><br><span class="line"><span class="keyword">if</span> (t.isCardPresent()) &#123;</span><br><span class="line">  cardTerminal = t;</span><br><span class="line">  <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// If not found, we throw an exception. Of course you should decide how to handle this situation</span></span><br><span class="line"><span class="keyword">if</span> (cardTerminal == <span class="keyword">null</span>) &#123;</span><br><span class="line">  <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"No terminal found"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// If a terminal is found, we connect to it</span></span><br><span class="line">Card apduCard = cardTerminal.connect(<span class="string">"*"</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// We create a PCSCCardChannel, which is an implementation of CardChannel and can be used with the rest of the SDK.</span></span><br><span class="line">PCSCCardChannel apduChannel = <span class="keyword">new</span> PCSCCardChannel(apduCard.getBasicChannel());</span><br></pre></td></tr></table></figure>
<h2 id="Working-with-the-card" class="article-heading"><a href="#Working-with-the-card" class="headerlink" title="Working with the card"></a>Working with the card<a class="article-anchor" href="#Working-with-the-card" aria-hidden="true"></a></h2><p>Regardless whether you are on Android or desktop, you should at this point have an implementation of the CardChannel interface (be it NFCCardChannel or PCSCCardChannel). You can now start working with the card. The first thing to do is creating a <code>KeycardCommandSet</code> instance. This class gives access to all of the applet functionality, wrapping the low-level APDUs in easy to use methods. All other classes in the SDK are helper to format parameters and parse responses from the card. To create a command set, just do</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// cardChannel is our CardChannel instance</span></span><br><span class="line">KeycardCommandSet cmdSet = <span class="keyword">new</span> KeycardCommandSet(cardChannel);</span><br></pre></td></tr></table></figure>
<p>Modern SmartCards can have several applications installed, so after connection with the card you need to select the Keycard applet. This is easily done with</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// The checkOK method can be called on any APDUResponse object to confirm that the</span></span><br><span class="line">cmdSet.select().checkOK();</span><br></pre></td></tr></table></figure>
<p>While this correctly selects the applet, it discards the card response, which contains information that can be useful to identify this specific card and its state. For this reason we could rewrite this as</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">ApplicationInfo info = <span class="keyword">new</span> ApplicationInfo(cmdSet.select().checkOK().getData());</span><br><span class="line"></span><br><span class="line"><span class="comment">// This method tells if the card is initialized (has a PIN, PUK and pairing password). If it is not, it must be</span></span><br><span class="line"><span class="comment">// initialized and no other operation is possible. Note that initialization touches only credentials to authenticate</span></span><br><span class="line"><span class="comment">// the user or the client, but does not touch the creation of a wallet on the card</span></span><br><span class="line">info.isInitializedCard();</span><br><span class="line"></span><br><span class="line"><span class="comment">// Returns the instance UID of the applet. This can be used to identify this specific applet instance, very</span></span><br><span class="line"><span class="comment">// useful when storing instance-specific data on the client (pairing info, cached data, etc).</span></span><br><span class="line">info.getInstanceUID();</span><br><span class="line"></span><br><span class="line"><span class="comment">// Returns the version of the applet.</span></span><br><span class="line">info.getAppVersion();</span><br><span class="line"></span><br><span class="line"><span class="comment">// Returns the number of free pairing slots. If you are not yet paired with the card, it helps you know if you can still</span></span><br><span class="line"><span class="comment">// pair or not</span></span><br><span class="line">info.getFreePairingSlots());</span><br><span class="line"></span><br><span class="line"><span class="comment">// Tells if the card has a wallet or not. If no wallet is available, you must create once before you can perform most</span></span><br><span class="line"><span class="comment">// operations on the card</span></span><br><span class="line">info.hasMasterKey();</span><br><span class="line"></span><br><span class="line"><span class="comment">// Returns the UID of the master key of the wallet. The UID is value generated starting from the public key and is </span></span><br><span class="line"><span class="comment">// useful to identify if the card has the expected wallet.</span></span><br><span class="line">info.getKeyUID();</span><br></pre></td></tr></table></figure>
<p>After the applet is selected, you can start working with it. Note that the application remains selected until another applet is explicitly selected, or the card is powered off (for example is removed from the field)</p>
<h3 id="Initialization" class="article-heading"><a href="#Initialization" class="headerlink" title="Initialization"></a>Initialization<a class="article-anchor" href="#Initialization" aria-hidden="true"></a></h3><p>This step is necessary to bring the initial credentials on the Keycard instance. When the card is not initialized, it cannot perform any operation. Initialization sets the initial PIN, PUK and pairing password and requires no authentication, but still uses a SecureChannel resistant to passive MITM attacks. Once the card is initialized, it cannot be initialized again (but credentials can be different with a different mechanism with previous authentication).</p>
<p>Initialization is done with</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Usually, you want to check if the card is initialized before trying to initialize it, otherwise you will receive an</span></span><br><span class="line"><span class="comment">// error.</span></span><br><span class="line"><span class="keyword">if</span> (!info.isInitializedCard()) &#123;</span><br><span class="line">  <span class="comment">// The PIN must be 6 digits, the PUK 12 digits and the pairing password can be any password. </span></span><br><span class="line">  <span class="comment">// All parameters are strings</span></span><br><span class="line">  cmdSet.init(pin, puk, pairingPassword).checkOK();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Pairing" class="article-heading"><a href="#Pairing" class="headerlink" title="Pairing"></a>Pairing<a class="article-anchor" href="#Pairing" aria-hidden="true"></a></h3><p>Clients wishing to communicate with the card, need to pair with it first. This allows creating secure channels resistant not only to passive but also to active MITM attacks. Although pairing allows the card and the client to authenticate each other, the card does not grant access to any operation with the wallet until the user is authenticated (by verifying its PIN). To establish the pairing, the client needs to know the pairing password. After it is established, the pairing info (not the password) must be stored as securely as possible on the client for subsequent sessions. You should store the pairing information together with the instance UID to simplify handling of multiple cards.</p>
<p>Only 5 clients can be paired at once, but it is possible to unpair previously paired clients.</p>
<p>Using the SDK, pairing is a simple operation</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// pairingPassword is usually provided by the user. This method throws an exception if pairing fails.</span></span><br><span class="line">cmdSet.autoPair(pairingPassword);</span><br><span class="line"><span class="comment">// Retrieves the pairing object from the command set. This is what must be persisted (together with the instance UID)</span></span><br><span class="line">Pairing pairing = cmdSet.getPairing();</span><br><span class="line"><span class="comment">// The pairing object can be serialized by calling</span></span><br><span class="line">pairing.toByteArray();</span><br><span class="line"><span class="comment">// or the convenience method</span></span><br><span class="line">pairing.toBase64();</span><br></pre></td></tr></table></figure>
<p>If you have already paired, you should instead load the persisted pairing information in the command set</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// serializedPairing can be either the byte array or base64 string representation</span></span><br><span class="line">Pairing pairing = <span class="keyword">new</span> Pairing(serializedPairing);</span><br><span class="line"><span class="comment">// Sets the pairing info in the command set. This must be done before further operation is possible</span></span><br><span class="line">cmdSet.setPairing(pairing);</span><br></pre></td></tr></table></figure>
<h3 id="Secure-Channel" class="article-heading"><a href="#Secure-Channel" class="headerlink" title="Secure Channel"></a>Secure Channel<a class="article-anchor" href="#Secure-Channel" aria-hidden="true"></a></h3><p>After a pairing has been established, a secure channel can be opened. Before opening a secure channel, the card won’t allow sending any command. This guarantees secrecy, integrity and authenticity of the commands. Opening a secure channel must be performed every time the applet is selected (this means also after a power loss). After opening it, the SDK handles the secure channel transparently, encrypting and signing all command APDUs and decrypting and verifying the signature of all responses. To open a secure channel all you need to do is</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">cmdSet.autoOpenSecureChannel();</span><br></pre></td></tr></table></figure>
<h3 id="Authenticating-the-user" class="article-heading"><a href="#Authenticating-the-user" class="headerlink" title="Authenticating the user"></a>Authenticating the user<a class="article-anchor" href="#Authenticating-the-user" aria-hidden="true"></a></h3><p>Most operations with the card (all involving operations with the wallet or credentials) require authenticating the user. After authentication, the user remains authenticated until the card is powered off or the application is re-selected.</p>
<p>Authentication is performed by verifying the user PIN. Note that this piece of information is sensitive and must be handled accordingly in the application. PIN verification is done with a single step</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// pin is the user PIN as a string of 6 digits</span></span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">  cmdSet.verifyPIN(pin).checkAuthOK();</span><br><span class="line">&#125; <span class="keyword">catch</span>(WrongPINException e) &#123;</span><br><span class="line">  System.out.println(<span class="string">"Number of remaining attempts: "</span> + e.getRetryAttempts());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>if the PIN is wrong, you will receive an error SW in the format 0x63CX where X is the number of attempts remaining. When the number of remaining attempts is 0, the card is blocked. The user must then enter the PUK and a new PIN to restore access to the card. The maximum number of retries for the PUK is 5. To simplify things, the <code>APDUResponse.checkAuthOK()</code> method can be used to verify if the authentication was correct, and if not throw a <code>WrongPINException</code> which contains the number of remaining attempts.</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">cmdSet.unblockPIN(puk, newPIN).checkAuthOK();</span><br></pre></td></tr></table></figure>
<h2 id="Creating-a-wallet" class="article-heading"><a href="#Creating-a-wallet" class="headerlink" title="Creating a wallet"></a>Creating a wallet<a class="article-anchor" href="#Creating-a-wallet" aria-hidden="true"></a></h2><p>To actually use the Keycard, it needs to have a wallet. This can be achieved in several different ways, which one you choose depends on your usage scenario. Creating a wallet requires user authentication and is possible even if a wallet already exists on the card (the new wallet replaces the old one). Use the <code>ApplicationInfo.hasMasterKey()</code> method to determine if the card already has a wallet or not. Note that the response of the <code>KeycardCommandSet.loadKey</code> method contains the key UID of the created wallet. This UID can be stored to keep track of this specific wallet in the client. The UID is tied to the key itself (is derived from the public key) so it will change if the wallet on card is replaced. The key UID is also part of the response of the applet selection command, so the wallet can be identified immediately upon selection.</p>
<h3 id="Creating-a-BIP39-mnemonic-phrase" class="article-heading"><a href="#Creating-a-BIP39-mnemonic-phrase" class="headerlink" title="Creating a BIP39 mnemonic phrase"></a>Creating a BIP39 mnemonic phrase<a class="article-anchor" href="#Creating-a-BIP39-mnemonic-phrase" aria-hidden="true"></a></h3><p>This method is great for interoperability with other wallets. The card can assist in creating the mnemonic phrase, since it features a TRNG. Generating the mnemonic itself does not require user authentication (since it does not modify the card state), but loading the key derived from it does. Example of the entire procedure is below</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Generates a Mnemonic object from the card. You can choose between generating 12, 15, 18, 21 or 24 words</span></span><br><span class="line">Mnemonic mnemonic = <span class="keyword">new</span> Mnemonic(cmdSet.generateMnemonic(KeycardCommandSet.GENERATE_MNEMONIC_12_WORDS).checkOK().getData());</span><br><span class="line"></span><br><span class="line"><span class="comment">// We need to set a wordlist if we plan using this object to derive the binary seed. We can set our own list or we can</span></span><br><span class="line"><span class="comment">// fatch the official BIP39 english word list as shown below.</span></span><br><span class="line">mnemonic.fetchBIP39EnglishWordlist();</span><br><span class="line"></span><br><span class="line"><span class="comment">// If we did not verify the PIN before, we can do it now</span></span><br><span class="line">cmdSet.verifyPIN(pin).checkOK();</span><br><span class="line"></span><br><span class="line"><span class="comment">// Loads the key generated from the mnemonic phrase.</span></span><br><span class="line">cmdSet.loadKey(mnemonic.toBIP32KeyPair()).checkOK();</span><br></pre></td></tr></table></figure>
<h3 id="Importing-a-wallet-from-BIP39-mnemonic-phrase" class="article-heading"><a href="#Importing-a-wallet-from-BIP39-mnemonic-phrase" class="headerlink" title="Importing a wallet from BIP39 mnemonic phrase"></a>Importing a wallet from BIP39 mnemonic phrase<a class="article-anchor" href="#Importing-a-wallet-from-BIP39-mnemonic-phrase" aria-hidden="true"></a></h3><p>Importing an existing passphrase requires only the loading step.</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// The passphrase is a string with space separated words. The password can be any non-null string, usually is empty.</span></span><br><span class="line">cmdSet.loadKey(Mnemonic.toBinarySeed(passphrase, password)).checkOK();</span><br></pre></td></tr></table></figure>
<h3 id="Generating-keys-on-card" class="article-heading"><a href="#Generating-keys-on-card" class="headerlink" title="Generating keys on-card"></a>Generating keys on-card<a class="article-anchor" href="#Generating-keys-on-card" aria-hidden="true"></a></h3><p>This is the simplest and safest method, because the generated wallet never leaves the card and there is no “paper backup” to keep secure. It is possible to create secure duplicates of the wallet on other Keycards, with a mechanism described in later chapters. Using the SDK, you simply do</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">cmdSet.generateKey().checkOK();</span><br></pre></td></tr></table></figure>
<h3 id="Importing-an-EC-keypair" class="article-heading"><a href="#Importing-an-EC-keypair" class="headerlink" title="Importing an EC keypair"></a>Importing an EC keypair<a class="article-anchor" href="#Importing-an-EC-keypair" aria-hidden="true"></a></h3><p>You can import on the keycard any EC keypair on the SECP256k1 curve, with or without the BIP32 extension. If your import a key without the BIP32 extension, then key derivation will not work, but you will still be able to use the Keycard for signing transactions using the imported key. This scenario can be useful if you are migrating from a wallet not using BIP39 passphrases or for wallets following some custom generation rules. It is however generally preferable to use one of the methods presented above.</p>
<p>An example of key import is</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// privKey is the S component of the key, as a 32-byte long byte array</span></span><br><span class="line"><span class="comment">// chainCode is the extension to the keypair defined by BIP32, this is another 32-byte long byte array. Can be null, in</span></span><br><span class="line"><span class="comment">// which case the created wallet won't be BIP32 compatible.</span></span><br><span class="line"><span class="comment">// pubKey is the DER encoded, uncompressed public key. Can be null, in which case it is automatically calculated from</span></span><br><span class="line"><span class="comment">// the private key.</span></span><br><span class="line">BIP32KeyPair keypair = <span class="keyword">new</span> BIP32KeyPair(privKey, chainCode, pubKey);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Loads the keypair</span></span><br><span class="line">cmdSet.loadKey(keypair).checkOK();</span><br></pre></td></tr></table></figure>
<h2 id="Key-derivation" class="article-heading"><a href="#Key-derivation" class="headerlink" title="Key derivation"></a>Key derivation<a class="article-anchor" href="#Key-derivation" aria-hidden="true"></a></h2><p>As mentioned before, the Keycard is a BIP32 compatible wallet. This means that it can perform key derivation as defined by the BIP32 specification in order to create a hierarchical deterministic wallet. When deriving a key, this key becomes active, which means that it will be used for all signing operations until a key with a different path is derived. The active key is persisted across sessions, meaning that a power loss or applet reselection does not reset it.</p>
<p>When creating or importing a wallet to the Keycard, the active key is the master key. Unless you imported a non-BIP32 compatible wallet, you usually want to set the active key to a currency account by following the BIP44 specifications for paths. Note that the maximum depth of the key path is 10, excluding the master key.</p>
<p>Key derivation requires user authentication</p>
<p>Since a line of code is worth a thousand words, below is an example of deriving a standard key path</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">cmdSet.deriveKey(<span class="string">"m/44'/0'/0'/0/0"</span>).checkOK();</span><br></pre></td></tr></table></figure>
<p>Since deriving a key is an expensive operation, you usually want to know what the current path is before performing derivation. You can do this with</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// you can then get is as a string with currentPath.toString()</span></span><br><span class="line">KeyPath currentPath = <span class="keyword">new</span> KeyPath(cmdSet.getStatus(KeycardCommandSet.GET_STATUS_P1_KEY_PATH).checkOK().getData());</span><br></pre></td></tr></table></figure>
<p>To speed up operations, key derivation can be started not only from the master key, but also from the parent or the current key. The path in this case starts respectively with “../“ and “./“. You cannot navigate the hierarchy with multiple “..” in the paths, because only the direct parent of the current key is cached. Derivation from parent is especially convenient when switching between accounts of the same type. Example</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Derive the main account</span></span><br><span class="line">cmdSet.deriveKey(<span class="string">"m/44'/0'/0'/0/0"</span>).checkOK();</span><br><span class="line"></span><br><span class="line"><span class="comment">// switch a secondary account, equivalent to "m/44'/0'/0'/0/1" but much faster</span></span><br><span class="line">cmdSet.deriveKey(<span class="string">"../1"</span>).checkOK();</span><br><span class="line"></span><br><span class="line"><span class="comment">// you can switch back and forth between siblings without limitations.</span></span><br><span class="line">cmdSet.deriveKey(<span class="string">"../0"</span>).checkOK();</span><br></pre></td></tr></table></figure>
<h2 id="Signing" class="article-heading"><a href="#Signing" class="headerlink" title="Signing"></a>Signing<a class="article-anchor" href="#Signing" aria-hidden="true"></a></h2><p>Your Keycard has been initialized, has a wallet and you have derived the keypath you need. You can now perform transactions by signing them with the card. Since the Keycard has no user input/output capabilities, it would be useless to transfer the entire transaction to the card for signing. You should instead calculate the transaction hash, according to the rules of the cryptocurrency you are handling and send that for signature instead. This also means, that you can handle anything which requires ECDSA signatures over SECP256k1 curve, regardless of the used hashing algorithm (at the condition that it output a 256-bit hash of course). This opens the door to signing transactions for the most common cryptocurrencies, but also makes it usable outside the realm of crypto transactions.</p>
<p>Signing is done as</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// hash is the hash to sign, for example the Keccak-256 hash of an Ethereum transaction</span></span><br><span class="line"><span class="comment">// the signature object contains r, s, recId and the public key associated to this signature</span></span><br><span class="line">RecoverableSignature signature = <span class="keyword">new</span> RecoverableSignature(hash, cmdSet.sign(hash).checkOK().getData());</span><br></pre></td></tr></table></figure>
<p>Signing requires user authentication.</p>
<h2 id="Exporting-public-or-EIP-1581-compliant-keys" class="article-heading"><a href="#Exporting-public-or-EIP-1581-compliant-keys" class="headerlink" title="Exporting (public or EIP-1581 compliant) keys"></a>Exporting (public or EIP-1581 compliant) keys<a class="article-anchor" href="#Exporting-public-or-EIP-1581-compliant-keys" aria-hidden="true"></a></h2><p>Sorry for the long title, but let’s make it immediately clear: the keys used to sign transactions never leave the card and cannot be exported. You can however export any public key as well as the private key of keypaths defined in the <a href="https://eips.ethereum.org/EIPS/eip-1581" target="_blank" rel="noopener">EIP-1581 specifications</a>. Those keys, by design, are not to be used for transactions but are instead usable for operations with lower security concerns where caching or storing the key outside the card might be beneficial from an UX point of view. Of course, exporting a key always requires user authentication.</p>
<h3 id="Exporting-the-current-key" class="article-heading"><a href="#Exporting-the-current-key" class="headerlink" title="Exporting the current key"></a>Exporting the current key<a class="article-anchor" href="#Exporting-the-current-key" aria-hidden="true"></a></h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Exports the current public key. This is allowed for any key path</span></span><br><span class="line">BIP32KeyPair publicKey = BIP32KeyPair.fromTLV(cmdSet.exportCurrentKey(<span class="keyword">true</span>).checkOK().getData());</span><br><span class="line"></span><br><span class="line"><span class="comment">// Exports the entire key pair. This is only allowed for key path following the EIP-1581 definition</span></span><br><span class="line">BIP32KeyPair keypair = BIP32KeyPair.fromTLV(cmdSet.exportCurrentKey(<span class="keyword">false</span>).checkOK().getData());</span><br></pre></td></tr></table></figure>
<h3 id="Derive-amp-export" class="article-heading"><a href="#Derive-amp-export" class="headerlink" title="Derive &amp; export"></a>Derive &amp; export<a class="article-anchor" href="#Derive-amp-export" aria-hidden="true"></a></h3><p>The export command is very powerful, since it allows you to derive &amp; export a key in one step. You have the option to make the derived and exported key active or leave the active key untouched. You can also decide whether to export only the public key or the entire keypair (following the rules defined above).</p>
<p>A very convenient use case is deriving an account key and retrieving the public key in one step. This is faster than doing it with two commands (derive key and export public), because every command processed has some overhead. Example</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// The first parameter is the keypath, the second tells whether that you want to make the derived &amp; exported key active</span></span><br><span class="line"><span class="comment">// and the third tells that you only want the public key to be exported.</span></span><br><span class="line">BIP32KeyPair publicKey = BIP32KeyPair.fromTLV(cmdSet.exportKey(<span class="string">"m/44'/0'/0'/0/0"</span>, <span class="keyword">true</span>, <span class="keyword">true</span>).checkOK().getData());</span><br><span class="line"></span><br><span class="line"><span class="comment">// The line above is equivalent to</span></span><br><span class="line"><span class="comment">// cmdSet.deriveKey("m/44'/0'/0'/0/0").checkOK();</span></span><br><span class="line"><span class="comment">// BIP32KeyPair publicKey = BIP32KeyPair.fromTLV(cmdSet.exportCurrentKey(true).checkOK().getData());</span></span><br></pre></td></tr></table></figure>
<p>Another use case, is to export keys defined by EIP-1581 without changing the current active key, since you won’t be signing with the exported key using the card</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Let's assume the current active path is "m/44'/0'/0'/0/0"</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// The first parameter is the key path, the second tells that you do not want to make it current and the third that you</span></span><br><span class="line"><span class="comment">// want the entire keypair, not only the public key</span></span><br><span class="line">BIP32KeyPair keypair = BIP32KeyPair.fromTLV(cmdSet.exportKey(<span class="string">"m/43'/60'/1581'/0'/0"</span>, <span class="keyword">false</span>, <span class="keyword">false</span>).checkOK().getData());</span><br><span class="line"></span><br><span class="line"><span class="comment">// At this point, the current active path would still be "m/44'/0'/0'/0/0"</span></span><br></pre></td></tr></table></figure>
<h2 id="Changing-credentials" class="article-heading"><a href="#Changing-credentials" class="headerlink" title="Changing credentials"></a>Changing credentials<a class="article-anchor" href="#Changing-credentials" aria-hidden="true"></a></h2><p>All credentials of the Keycard can be changed (PIN, PUK, pairing password). Changing the pairing password does not invalidate existing pairings, but applies to the ones which can be created in the future. Changing credentials, requires user authentication.</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Changes the user PIN</span></span><br><span class="line">cmdSet.changePIN(<span class="string">"123456"</span>).checkOK();</span><br><span class="line"></span><br><span class="line"><span class="comment">// Changes the PUK</span></span><br><span class="line">cmdSet.changePUK(<span class="string">"123456123456"</span>).checkOK();</span><br><span class="line"></span><br><span class="line"><span class="comment">// Changes the pairing password</span></span><br><span class="line">cmdSet.changePairingPassword(<span class="string">"my pairing password"</span>).checkOK();</span><br></pre></td></tr></table></figure>
<h2 id="Duplication" class="article-heading"><a href="#Duplication" class="headerlink" title="Duplication"></a>Duplication<a class="article-anchor" href="#Duplication" aria-hidden="true"></a></h2><p>Card duplication is especially relevant when the keys have been generated on-card, without using BIP39 mnemonic (or when this has been destroyed). To make duplication secure the client must not possess the (full) encryption key. For this reason, a scheme where multiple clients are used and none of them has the full key has been devised. From the user point of view, the duplication process goes like this</p>
<ol>
<li>Take the card to be duplicated (source) and one or more cards to duplicate to (target)</li>
<li>On one of the user’s clients initiate the duplication. This involves entering the PIN of each of the involved cards</li>
<li>Tap all cards to one or more additional clients (the amount must be defined before, the order is irrelevant). These clients do not need to be paired or be trusted, so the user can borrow a friend’s phone without compromising security. This step does not require entering a PIN</li>
<li>On one of the user’s clients, usually the same which initiated the duplication (must be paired, trusted) finalize the duplication by first tapping the source card and then all target cards, again inserting the PIN for each.</li>
</ol>
<p>At the end of procedure, each card will have the same master key, but PIN, PUK and pairing key remain unchanged and are independent from each other. A client could propose changing them to be all the same if desired or do this automatically. All cards are fully functional, so at this point there isn’t any difference between the source card and the targets.</p>
<p>Since the cards are still protected by the PIN, these can be stored remotely in moderately trusted places to recover from lost or destroyed cards. The duplication has been performed securely since no client ever had the full encryption key and no authentication credentials has been inserted on untrusted clients. For flexibility reason, an arbitrary number of clients can be used. Using a single client could be convenient from an UX point of view, but relies on said client not being compromised. Using 2 or 3 clients greatly increases security. More than 3 clients is probably an overkill.</p>
<p>From an implementation point of view, we have two different roles a client can take</p>
<ol>
<li>The trusted client, starting and performing the duplication</li>
<li>The (possibly) untrusted clients, only adding entropy to the encryption key</li>
</ol>
<p>Both can be implemented by using the <code>CardDuplicator</code> class. On each client, the same instance of the <code>CardDuplicator</code> class must be used for the entire duplication process, otherwise duplication will fail.</p>
<p>The trusted client must also provide an implementation of <code>DuplicatorCallback</code>. This is needed to retrieve the Pairing and PIN for each card. Example below</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyDuplicatorCB</span> <span class="keyword">implements</span> <span class="title">DuplicatorCallback</span> </span>&#123;</span><br><span class="line">  <span class="function">Pairing <span class="title">getPairing</span><span class="params">(ApplicationInfo applicationInfo)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// The Instance UID is the one to use when storing/retrieving pairings</span></span><br><span class="line">    <span class="keyword">byte</span>[] uid = applicationInfo.getInstanceUID();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Using the UID try to retrieve the pairing. The method getSavedPairing is an example and is not part of the SDK,</span></span><br><span class="line">    <span class="comment">// you are responsible of how you store and retrieve pairing data in your app</span></span><br><span class="line">    Pairing pairing = getSavedPairing(uid);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Optionally, you could prompt the user and make a new pairing if none if given, but this is an UX decision in</span></span><br><span class="line">    <span class="comment">// your application.</span></span><br><span class="line">    <span class="keyword">if</span> (pairing == <span class="keyword">null</span>) &#123;</span><br><span class="line">      pairing = tryToPair();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// possibly null, in this case the operation requiring pairing is aborted</span></span><br><span class="line">    <span class="keyword">return</span> pairing;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="function">String <span class="title">getPIN</span><span class="params">(ApplicationInfo applicationInfo, <span class="keyword">int</span> remainingAttempts)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// Optionally, you might have a cache of PINs for recently used card, but this should be done carefully as the PIN</span></span><br><span class="line">    <span class="comment">// is sensitive data. You might instead want to just prompt the user each time.</span></span><br><span class="line">    String pin = getCachedPIN(applicationInfo.getInstanceUID());</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (pin == <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="comment">// prompt the user to insert the PIN. You can optionally inform them about how many retry attempts are left.</span></span><br><span class="line">      <span class="comment">// For UX reason you could also use the instance UID to show the user an identifiable name, this is again</span></span><br><span class="line">      <span class="comment">// application specific.</span></span><br><span class="line">      pin = promptUser(remainingAttempts);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// This must not be null. PIN verification will be performed by the CardDuplicator itself, do no not perform it here!</span></span><br><span class="line">    <span class="keyword">return</span> pin;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>The next step to do, is instantiating a CardDuplicator.</p>
<p>For the trusted client</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// The cmdSet is a KeycardCommandSet instance, duplicatorCallback is an object implementing the DuplicatorCallback</span></span><br><span class="line"><span class="comment">// interface</span></span><br><span class="line">cardDuplicator = <span class="keyword">new</span> CardDuplicator(cmdSet, duplicatorCallback);</span><br></pre></td></tr></table></figure>
<p>For the untrusted clients</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// apduChannel is a CardChannel instance. Alternatively the same constructor as for the trusted client can be used,</span></span><br><span class="line"><span class="comment">// passing null as the second parameter.</span></span><br><span class="line">cardDuplicator = <span class="keyword">new</span> CardDuplicator(apduChannel);</span><br></pre></td></tr></table></figure>
<p>Once the instance has been created, depending on the role and state the client must perform a specific action every time a new card is presented. The CardDuplicator keeps track of the action performed on any card, so if the user presents the same card twice an <code>IllegalStateException</code> exception is thrown.</p>
<p>To start duplication on a card, for example, you might do</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Client count is the amount of devices contributing to forming the entire key. This means 1 + the number of clients</span></span><br><span class="line"><span class="comment">// which will be adding entropy (the untrusted clients)</span></span><br><span class="line">cardDuplicator.startDuplication(clientCount);</span><br></pre></td></tr></table></figure>
<p>On untrusted clients, to add entropy, you do</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">cardDuplicator.addEntropy();</span><br></pre></td></tr></table></figure>
<p>When the full key has been stored on all cards, you then call the following method on the source card on a trusted client</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">byte</span>[] exportedKey = cardDuplicator.exportKey();</span><br></pre></td></tr></table></figure>
<p>whereas, from the same client, you invoke on all target cards the following</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// you should then check that the keyUID matches the one of the source card to be sure that the duplication has been</span></span><br><span class="line"><span class="comment">// performed correctly.</span></span><br><span class="line"><span class="keyword">byte</span>[] keyUID = cardDuplicator.importKey(exportedKey);</span><br></pre></td></tr></table></figure>

              </div>
              <footer class="article-footer">
                <time class="article-footer-updated" datetime="2019-01-24T08:51:18.558Z" itemprop="dateModified">Last updated: 2019-01-24</time>
                <a href="index.html" class="article-footer-prev" title="Getting Started"><i class="fa fa-chevron-left"></i><span>Prev</span></a><a href="apdu.html" class="article-footer-next" title="APDU Protocol"><span>Next</span><i class="fa fa-chevron-right"></i></a>
              </footer>
            </div>
          </div>
        </div>
      </article>
    </div>
  </div>
</div>

    
<div class="footer footer--global">
    <div class="footer-inner">
        <div class="footer-table">
            <div class="footer-table__column">
                <p class="footer-header">Social links</p>
                <ul class="footer-list">
                    <li class="footer-link footer-link--fb"><a href="https://www.facebook.com/ethstatus" target="_blank"><span class="footer-icon"></span><span class="footer-link-label">Facebook</span></a></li>
                    <li class="footer-link footer-link--tw"><a href="https://twitter.com/ethstatus" target="_blank"><span class="footer-icon"></span><span class="footer-link-label">Twitter</span></a></li>
                    <li class="footer-link footer-link--ri"><a href="https://chat.status.im/#/register" target="_blank"><span class="footer-icon"></span><span class="footer-link-label">Riot</span></a></li>
                    <li class="footer-link footer-link--gh"><a href="https://github.com/status-im" target="_blank"><span class="footer-icon"></span><span class="footer-link-label">Github</span></a></li>
                    <li class="footer-link footer-link--rd"><a href="https://www.reddit.com/r/statusim/" target="_blank"><span class="footer-icon"></span><span class="footer-link-label">Reddit</span></a></li>
                    <li class="footer-link footer-link--yt"><a href="https://www.youtube.com/statusim" target="_blank"><span class="footer-icon"></span><span class="footer-link-label">YouTube</span></a></li>
                </ul>
            </div>

            <div class="footer-table__column">
                <p class="footer-header">More</p>
                <ul class="footer-list">
                    <li class="footer-link"><a href="https://status.im/docs/" target="_blank">Status Docs</a></li>
                    <li class="footer-link"><a href="https://our.status.im/" target="_blank">Status Blog</a></li>
                    <li class="footer-link"><a href="https://status.im/contribute/" target="_blank">Jobs</a></li>
                    <li class="footer-link"><a href="https://status.im/privacy-policy.html" target="_blank">Privacy Policy</a></li>
                </ul>
            </div>

            <div class="footer-table__column">
                <p class="footer-header">Projects</p>
                <ul class="footer-list">
                    <li class="footer-link"><a href="https://embark.status.im" target="_blank">Embark</a></li>
                    <li class="footer-link"><a href="https://hardwallet.status.im/" target="_blank">Keycard</a></li>
                    <li class="footer-link"><a href="https://incubate.status.im/" target="_blank">Incubate</a></li>
                    <li class="footer-link"><a href="https://nimbus.status.im/" target="_blank">Nimbus</a></li>
                </ul>
            </div>
        </div>
    
        <div class="footer-logo-wrap">
            <div class="footer-logo-wrap__inner">
                <a class="footer-logo" href="https://status.im" target="_blank"></a>
                <div class="footer-address secondary-text">Status Research & Development GmbH<br>Baarerstrasse 10<br>Zug, Switzerland</div>
            </div>
        </div>
    </div>
</div>

  </div>
  <div id="mobile-nav-dimmer"></div>
  <div class="backdrop"></div>
<div class="mobile-menu-container">
  <div class="mobile-menu-container-inner">
    <div class="mobile-menu-header">
      <div class="logo-wrap">
          <span class="logo-span"><a class="logo" href="/"></a></span>
          <span class="logo-span"><a class="logo-text" href="/">status</a></span>
      </div>
      <a href="#" class="close">
        <svg width="24" height="24" viewbox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path fill-rule="evenodd" clip-rule="evenodd" d="M12 10.574L7.72275 6.2968C7.32616 5.90021 6.68994 5.90241 6.29617 6.29617C5.89966 6.69269 5.90269 7.32864 6.2968 7.72275L10.574 12L6.2968 16.2772C5.90021 16.6738 5.90241 17.3101 6.29617 17.7038C6.69269 18.1003 7.32864 18.0973 7.72275 17.7032L12 13.426L16.2772 17.7032C16.6738 18.0998 17.3101 18.0976 17.7038 17.7038C18.1003 17.3073 18.0973 16.6714 17.7032 16.2772L13.426 12L17.7032 7.72275C18.0998 7.32616 18.0976 6.68994 17.7038 6.29617C17.3073 5.89966 16.6714 5.90269 16.2772 6.2968L12 10.574Z" fill="black"/>
        </svg>
      </a>
    </div>
    <div class="ecosystem">
      <span class="title">Ecosystem</span>
    </div>
    <div class="community">
      <span class="title">Community</span>
    </div>
  </div>
  <div class="mobile-submenu-container-inner">
    <div class="mobile-menu-header">
      <a href="#" class="back">
        <svg width="24" height="24" viewbox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path fill-rule="evenodd" clip-rule="evenodd" d="M7.00687 12.1016C7.02704 12.3261 7.1228 12.5448 7.29281 12.7143L14.3042 19.7079C14.6926 20.0953 15.3188 20.0988 15.7089 19.7097C16.0963 19.3232 16.0907 18.6911 15.7072 18.3085L9.38119 11.9986L15.7072 5.68865C16.0956 5.30126 16.099 4.67664 15.7089 4.28751C15.3215 3.90107 14.6877 3.9067 14.3042 4.28924L7.29281 11.2828C7.06819 11.5069 6.97231 11.8103 7.00687 12.1016Z" fill="black"/>
        </svg>
      </a>
      <span class="title">Status app</span>
      <a href="#" class="close">
        <svg width="24" height="24" viewbox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path fill-rule="evenodd" clip-rule="evenodd" d="M12 10.574L7.72275 6.2968C7.32616 5.90021 6.68994 5.90241 6.29617 6.29617C5.89966 6.69269 5.90269 7.32864 6.2968 7.72275L10.574 12L6.2968 16.2772C5.90021 16.6738 5.90241 17.3101 6.29617 17.7038C6.69269 18.1003 7.32864 18.0973 7.72275 17.7032L12 13.426L16.2772 17.7032C16.6738 18.0998 17.3101 18.0976 17.7038 17.7038C18.1003 17.3073 18.0973 16.6714 17.7032 16.2772L13.426 12L17.7032 7.72275C18.0998 7.32616 18.0976 6.68994 17.7038 6.29617C17.3073 5.89966 16.6714 5.90269 16.2772 6.2968L12 10.574Z" fill="black"/>
        </svg>
      </a>
    </div>
    <div class="dropdown">
      <nav></nav>
    </div>
  </div>
</div>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.0/clipboard.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.13.1/highlight.min.js"></script>
<script src="/keycard.status.im/js/vendor.min.js"></script>

</body>
</html>
